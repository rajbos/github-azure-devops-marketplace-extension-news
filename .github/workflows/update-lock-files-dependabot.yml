name: Update Lock Files for Dependabot PRs

on:
  pull_request:
    paths:
      - 'Directory.Packages.props'
      - 'AzDoExtensionNews/**/*.csproj'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-lock-files:
    # Only run on Dependabot PRs
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
      with:
        disable-sudo: true
        egress-policy: block
        allowed-endpoints: >
          api.nuget.org:443
          dc.services.visualstudio.com:443
          github.com:443
          dotnetcli.azureedge.net:443
          aka.ms:443
          builds.dotnet.microsoft.com:443
          ci.dot.net:443

    - name: Checkout PR
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v3.5.3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ github.head_ref }}

    - name: Setup .NET
      uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602 # v5.0.1
      with:
        dotnet-version: 8.0.x

    - name: Update lock files
      run: |
        echo "Updating package lock files to match dependency changes"
        echo "This includes changes from Directory.Packages.props and .csproj files"
        dotnet restore AzDoExtensionNews/AzDoExtensionNews.sln --use-lock-file --force-evaluate

    - name: Check for lock file changes
      id: check_changes
      run: |
        if [[ -n $(git status --porcelain "**/packages.lock.json") ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Lock files have been updated"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No lock file changes needed"
        fi

    - name: Commit updated lock files
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add "**/packages.lock.json"
        git commit -m "chore: update package lock files for dependency changes

        Updates lock files to reflect changes in Directory.Packages.props and project references.
        This prevents NU1004 errors when project dependencies are updated.

        Co-authored-by: dependabot[bot] <49699333+dependabot[bot]@users.noreply.github.com>"
        git push